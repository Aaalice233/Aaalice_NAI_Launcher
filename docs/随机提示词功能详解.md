# NAI-Generator-Flutter 随机提示词功能详解

## 目录

1. [功能概述](#功能概述)
2. [核心数据结构](#核心数据结构)
3. [配置选项详解](#配置选项详解)
4. [选择算法说明](#选择算法说明)
5. [选项联动关系](#选项联动关系)
6. [变量替换系统](#变量替换系统)
7. [角色配置系统](#角色配置系统)
8. [生成流程](#生成流程)
9. [与其他功能的集成](#与其他功能的集成)
10. [文件名动态生成](#文件名动态生成)
11. [配置存储机制](#配置存储机制)
12. [UI 操作指南](#ui-操作指南)
13. [配置示例](#配置示例)
14. [相关文件索引](#相关文件索引)

---

## 功能概述

随机提示词功能是 NAI-Generator-Flutter 的核心功能，允许用户构建**递归嵌套的提示词配置树**，实现高度灵活的随机组合生成。

### 核心特性

- **递归嵌套结构**：支持无限层级的配置嵌套
- **多种选择算法**：5 种不同的选择模式
- **随机权重调整**：自动添加增强/降权括号
- **变量引用系统**：通过 `__变量名__` 引用已保存的配置
- **角色独立配置**：每个角色拥有独立的随机提示词配置（最多 5 个）
- **文件名动态生成**：支持在输出文件名中嵌入随机生成的内容
- **多平台支持**：Windows、Android、Web 全平台适配

---

## 核心数据结构

### PromptConfig（配置节点）

每个配置节点包含以下属性：

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `type` | String | `'str'` | 节点类型：`str`（字符串列表）或 `config`（嵌套配置） |
| `selectionMethod` | String | `'all'` | 选择算法 |
| `strs` | List\<String\> | `[]` | 当 type 为 `str` 时，存储待选的提示词字符串 |
| `prompts` | List\<PromptConfig\> | `[]` | 当 type 为 `config` 时，存储子配置列表 |
| `prob` | double | `0.0` | 概率选择时的选中概率 |
| `num` | int | `1` | 数量选择时的选中数量 / 顺序遍历时的重复次数 |
| `shuffled` | bool | `true` | 是否打乱结果顺序 |
| `randomBracketsUpper` | int | `0` | 随机括号数量上限 |
| `randomBracketsLower` | int | `0` | 随机括号数量下限 |
| `comment` | String | `'Unnamed config'` | 配置名称/注释（用于变量引用和文件名生成） |
| `filter` | String | `''` | 过滤条件（保留字段） |
| `enabled` | bool | `true` | 是否启用此配置 |

**文件位置**: `lib/data/models/prompt_config.dart:122-152`

### NestedPrompt（生成结果树）

生成过程产生的中间结构，支持深度优先搜索：

- **NestedPromptString**：叶子节点，包含最终生成的字符串
  - `title`：配置名称（对应 comment）
  - `content`：生成的提示词内容
  - `findPromptWithKey(key)`：按名称查找内容

- **NestedPromptList**：容器节点，包含子节点列表
  - `toPrompt()`：将树形结构扁平化为逗号分隔的字符串
  - `toComment()`：生成可读的层级解析日志

**文件位置**: `lib/data/models/prompt_config.dart:3-120`

---

## 配置选项详解

### 1. 节点类型 (type)

| 值 | 中文名称 | 说明 |
|----|----------|------|
| `str` | 字符串内容 | 此节点包含一个字符串列表，每行一个提示词 |
| `config` | 嵌套 Config | 此节点包含子配置节点，形成树形结构 |

### 2. 选择方法 (selectionMethod)

| 值 | 中文名称 | 说明 |
|----|----------|------|
| `all` | 全部 | 选中所有启用的子项 |
| `single` | 单个 - 随机选择 | 从子项中随机抽取 1 个 |
| `single_sequential` | 单个 - 顺序遍历 | 按顺序轮流抽取 1 个，支持重复次数 |
| `multiple_num` | 多个 - 指定数量 | 随机打乱并抽取固定数量的子项 |
| `multiple_prob` | 多个 - 指定选中概率 | 对每个子项按概率独立决定是否选中 |

### 3. 随机括号 (randomBrackets)

括号用于调整 NovelAI 中提示词的权重：

- **正数**：使用 `{}` 括号（增强权重，每层约 1.05 倍）
- **负数**：使用 `[]` 括号（降低权重，每层约 0.95 倍）
- **范围**：系统会在 `randomBracketsLower` 到 `randomBracketsUpper` 之间随机选择
- **UI 范围**：-10 ~ +10

示例：
- 设置范围 `-2 ~ 3`
- 可能输出：`[[prompt]]`（降权）、`prompt`（无变化）、`{{{prompt}}}`（增权）

**算法实现**:
```dart
int n = randomBracketsLower + Random().nextInt(randomBracketsUpper - randomBracketsLower + 1);
if (n < 0) {
  brackets = ["[", "]"];
  n = -n;
} else {
  brackets = ["{", "}"];
}
```

**文件位置**: `lib/data/models/prompt_config.dart:203-217`

---

## 选择算法说明

### all（全部）

```
输入: [A, B, C, D]
输出: [A, B, C, D] 或打乱后的顺序
```

- 选中所有启用的子项
- 受 `shuffled` 参数影响顺序
- 适用场景：固定前缀/后缀、质量标签

### single（单个随机）

```
输入: [A, B, C, D]
输出: [B] （随机选中一个）
```

- 每次随机选择一个子项
- `shuffled` 参数无效（只有一个结果）
- 适用场景：角色抽选、场景选择

### single_sequential（顺序遍历）

```
配置: num=2
第1次调用: A
第2次调用: A
第3次调用: B
第4次调用: B
...循环
```

- 按顺序轮流选择
- `num` 参数控制每个项目重复抽取的次数
- 内部维护索引状态 `_sequentialIdx` 和 `_sequentialRepeatIdx`
- 适用场景：批量测试、系统性遍历所有选项

**文件位置**: `lib/data/models/prompt_config.dart:248-255`

### multiple_num（指定数量）

```
输入: [A, B, C, D, E], num=3
输出: [C, A, E] （随机选3个，不重复）
```

- 先打乱列表，再取前 `num` 个
- 结果已经是打乱的
- 适用场景：混合画师风格、多标签组合

### multiple_prob（指定概率）

```
输入: [A, B, C, D, E], prob=0.5
输出: [A, C] （每个有50%概率被选中）
```

- 每个子项独立判断是否选中
- 选中数量不固定，期望值 = 总数 × prob
- 受 `shuffled` 参数影响顺序
- 适用场景：低概率特殊效果、随机装饰元素

---

## 选项联动关系

不同选择方法下，UI 会动态显示/隐藏相关选项：

| 选择方法 | shuffled | prob | num |
|----------|----------|------|-----|
| `all` | ✅ 显示 | ❌ 隐藏 | ❌ 隐藏 |
| `single` | ❌ 隐藏 | ❌ 隐藏 | ❌ 隐藏 |
| `single_sequential` | ❌ 隐藏 | ❌ 隐藏 | ❌ 隐藏* |
| `multiple_num` | ❌ 隐藏 | ❌ 隐藏 | ✅ 显示（选中数量） |
| `multiple_prob` | ✅ 显示 | ✅ 显示 | ❌ 隐藏 |

> **\*注意**：`single_sequential` 模式的 `num` 参数（重复次数）在 UI 编辑器中**没有提供编辑入口**，需要通过 JSON 导入/导出来修改。但该参数在配置描述中会正确显示（当 num > 1 时）。

**相关代码位置**:
- `lib/ui/prompt_config/widgets/prompt_config_edit_view.dart:82-97`（shuffled 联动）
- `lib/ui/prompt_config/widgets/prompt_config_edit_view.dart:99-113`（prob 联动）
- `lib/ui/prompt_config/widgets/prompt_config_edit_view.dart:145-157`（num 联动）

### 联动逻辑说明

1. **shuffled（打乱次序）**
   - 仅在 `all` 和 `multiple_prob` 模式下显示
   - 因为这两种模式结果可能包含多个项，顺序才有意义

2. **prob（选中概率）**
   - 仅在 `multiple_prob` 模式下显示
   - 范围：0.0 ~ 1.0，精度 0.01

3. **num（选中数量/重复次数）**
   - 在 `multiple_num` 模式：表示要选中的数量（UI 可编辑）
   - 在 `single_sequential` 模式：表示每个项目重复抽取的次数（**需通过 JSON 编辑**）

---

## 变量替换系统

### 基本语法

使用 `__变量名__` 格式引用已保存的配置：

```
输入提示词: "1girl, __发色__, __眼睛颜色__, best quality"
```

如果在"保存的配置"中有名为"发色"和"眼睛颜色"的配置，系统会递归生成并替换。

### 替换规则

1. 系统使用正则表达式匹配 `__xxx__` 格式
2. 在 `savedPromptConfigList` 中查找 `comment` 匹配的配置
3. 调用匹配配置的 `getPrmpts()` 方法生成内容
4. 如果未找到匹配，保持原样 `__xxx__`

**正则表达式**:
```dart
RegExp(r'__([\p{L}0-9_\-（）().\u4e00-\u9fff\uff00-\uffef]+?)__', unicode: true)
```

支持字符：
- 字母（所有 Unicode 字母）
- 数字（0-9）
- 下划线、连字符
- 中文字符
- 日文假名
- 全角/半角括号
- 点号

**文件位置**: `lib/data/use_cases/generate_payload_use_case.dart:66-82`

### 使用场景

1. **复用配置**：将常用的提示词组合保存，在多处引用
2. **模块化管理**：按类别（发型、服装、场景等）组织配置
3. **动态生成**：每次引用时都会重新执行随机选择
4. **文件名嵌入**：在文件名前缀中使用变量，自动包含生成内容

### 保存配置管理

通过 UI 中的"管理保存的提示词配置"入口，可以：
- 添加新配置
- 从剪贴板导入 JSON 配置
- 删除不需要的配置
- 每个保存的配置都可以被 `__配置名__` 引用

**文件位置**: `lib/ui/saved_config_list/widgets/saved_config_list_view.dart`

---

## 角色配置系统

### CharacterConfig 结构

| 属性 | 类型 | 说明 |
|------|------|------|
| `positions` | List\<Point\<int\>\> | 角色可能出现的位置列表（随机选择一个） |
| `positivePromptConfig` | PromptConfig | 角色的正向提示词配置（完整支持随机功能） |
| `negativePrompt` | String | 角色专属的反向提示词 |
| `enabled` | bool | 是否启用此角色 |

**文件位置**: `lib/data/models/character_config.dart:17-83`

### 位置坐标系统

位置使用 6×6 网格表示（X: 0-5, Y: 0-5）：

| 索引值 | 显示标签 | API 实际值 |
|--------|----------|------------|
| 0 | X | 0.0 |
| 1 | A | 0.1 |
| 2 | B | 0.3 |
| 3 | C | 0.5 |
| 4 | D | 0.7 |
| 5 | E | 0.9 |

Y 值使用相同映射。例如位置 `(3, 5)` 显示为 `C5`，实际坐标为 `(0.5, 0.9)`。

### 随机位置选择

如果配置了多个可能位置，系统会随机选择一个：

```dart
if (positions.isNotEmpty) {
  positionAsInt = positions[random.nextInt(positions.length)];
}
```

### 角色数量限制

- 最多支持 5 个角色
- 每个角色拥有独立的随机提示词配置
- 支持角色间的拖拽重排序

### V4 模型特殊处理

针对 NAI V4 模型，角色配置会生成结构化的 `v4_prompt`：

```json
{
  "caption": {
    "base_caption": "基础提示词",
    "char_captions": [
      {"char_caption": "角色1提示词", "centers": [{"x": 0.5, "y": 0.9}]},
      {"char_caption": "角色2提示词", "centers": [{"x": 0.3, "y": 0.5}]}
    ]
  }
}
```

---

## 生成流程

完整的提示词生成流程（`GeneratePayloadUseCase.call()`）：

### 步骤 1：检查覆盖模式

```
if (useOverridePrompt) {
  → 直接使用 overridePrompt 字符串
} else {
  → 执行随机生成流程
}
```

### 步骤 2：生成基础提示词

```
rootPromptConfig.getPrmpts()
  └── 递归调用子配置的 getPrmpts()
      └── 根据 type 和 selectionMethod 选择内容
          └── 应用 addRandomBrackets() 添加权重括号
```

### 步骤 3：变量替换

```
basePromptResult.replaceVariables(pattern, savedConfigList)
  └── 匹配 __xxx__ 格式
      └── 在 savedConfigList 中查找
          └── 递归生成替换内容
```

### 步骤 4：生成角色提示词

```
for each enabled character:
  └── character.getPrompt()
      └── positivePromptConfig.getPrmpts()
      └── 随机选择位置
      └── replaceVariables() 替换变量
```

### 步骤 5：处理文件名

```
_processFileNameKey(fileNameKey, basePromptResult)
  └── 匹配文件名模板中的 __xxx__
      └── 调用 findPromptWithKey() 查找对应内容
          └── 替换为实际生成的提示词
```

### 步骤 6：组装最终结果

```
PayloadGenerationResult {
  payload: API 请求体,
  comment: 可读的生成日志,
  suggestedFileName: 处理后的文件名
}
```

**文件位置**: `lib/data/use_cases/generate_payload_use_case.dart:65-194`

---

## 与其他功能的集成

### 1. Vibe Transfer

Vibe Transfer 与随机提示词是**并行且解耦**的：

- 随机提示词负责"内容描述"
- Vibe Transfer 负责"视觉风格控制"
- 两者在生成时汇聚到同一个 API Payload

**NAI V3 模式**:
- `reference_image_multiple`：多张参考图的 Base64
- `reference_strength_multiple`：各图的强度
- `reference_information_extracted_multiple`：信息提取量

**NAI V4 模式**:
- 从 PNG 的 `iTXt` 块提取 Vibe Encoding
- 或从 `.naiv4vibe` / `.naiv4vibebundle` 文件加载

### 2. 图生图 (I2I)

I2I 配置拥有独立的提示词覆盖选项：

| 选项 | 说明 |
|------|------|
| `overridePromptEnabled` | 是否使用图片原始提示词 |
| `overridePrompt` | 覆盖用的提示词内容 |

**元数据导入**：导入 NAI 生成的图片时，可自动解析并导入原始提示词和参数。

### 3. Enhance 预设

将复杂参数简化为 5 级预设：

| 级别 | Strength | Noise | 效果 |
|------|----------|-------|------|
| 1 | 0.2 | 0.0 | 最轻微改变 |
| 2 | 0.4 | 0.0 | 轻度变化 |
| 3 | 0.5 | 0.0 | 平衡 |
| 4 | 0.6 | 0.0 | 明显变化 |
| 5 | 0.7 | 0.1 | 大幅度重绘 |

### 4. Director Tools

Director Tools 中的 `emotion` 工具支持随机表情生成：

```dart
final emotions = ['happy', 'smug', 'determined', 'excited', ...共24种];
final randomEmotion = emotions[Random().nextInt(emotions.length)];
```

当未启用覆盖时，系统会从预设表情列表中随机抽取。

### 5. 覆盖提示词模式

| 选项 | 说明 |
|------|------|
| `useOverridePrompt` | 完全跳过随机生成，使用固定提示词 |
| `useCharacterPromptWithOverride` | 即使开启覆盖，仍生成随机角色描述 |

### 6. 参数随机化

除提示词外，以下参数也支持随机化：

| 参数 | 随机化方式 |
|------|-----------|
| Seed | `Random().nextInt(1 << 32 - 1)` |
| 尺寸 | 从 `sizes` 列表中随机选择 |

---

## 文件名动态生成

### 配置入口

在设置页面的"输出文件前缀"中配置模板。

### 语法

使用 `__配置名__` 格式嵌入随机生成的内容：

```
模板: portrait-__画师__-__角色__
输出: portrait-artist_test-character_a
```

### 实现机制

1. 系统在生成提示词后，调用 `_processFileNameKey()`
2. 使用 `findPromptWithKey()` 方法在结果树中搜索
3. 按 DFS（深度优先）顺序查找 `comment` 匹配的节点
4. 返回该节点本次随机生成的实际内容

**代码示例**:
```dart
String _processFileNameKey(String rawKey, NestedPrompt prompt) {
  return rawKey.replaceAllMapped(
    RegExp(r'__([\p{L}0-9_\-（）().\u4e00-\u9fff\uff00-\uffef]+?)__', unicode: true),
    (match) => prompt.findPromptWithKey(match[1].toString()) ?? '__${match[1]}__',
  );
}
```

### 辅助功能

- **时间戳**：`FileService.generateTimestampString()` → `YYYYMMDDHHmmss`
- **随机后缀**：`FileService.generateRandomString()` → 6 位 `[a-z0-9]`

---

## 配置存储机制

### 存储引擎

项目使用 **Hive** 键值对数据库进行本地持久化：

- 配置索引存储在 `configIndex` 键
- 各配置以 UUID 为键存储 JSON 字符串
- 通过 `GetIt` 依赖注入全局共享

### 多配置管理

| 功能 | 说明 |
|------|------|
| 保存当前配置 | 序列化为 JSON 并存入 Hive |
| 加载已保存配置 | 从索引选择并反序列化 |
| 切换配置 | 更新 `savedUuid` 并重新加载 |
| 删除配置 | 从索引和数据库中移除 |

### 导入导出

| 操作 | 实现方式 |
|------|----------|
| 导出到文件 | `FilePicker` + `FileService.saveStringToFile()` |
| 从文件导入 | `FilePicker` + `json.decode()` + `payloadConfig.loadJson()` |
| 导出到剪贴板 | `Clipboard.setData()` |
| 从剪贴板导入 | `Clipboard.getData()` + `json.decode()` |

### 跨平台差异

| 功能 | Windows | Android | Web |
|------|---------|---------|-----|
| 存储方式 | Hive (文件系统) | Hive (文件系统) | Hive (IndexedDB) |
| 文件导出 | 原生保存对话框 | FilePicker.saveFile | Blob 下载 |
| 图片保存 | 指定目录写入 | saver_gallery | Blob URL |
| 权限 | 无需特殊权限 | 需存储权限 | 无需特殊权限 |

**文件位置**:
- `lib/data/services/config_service.dart`
- `lib/data/services/file_service.dart`

---

## UI 操作指南

### 主界面结构

配置使用 `ExpansionTile` 展示递归树形结构：

```
▼ 根配置 [全部 / 顺序 / 嵌套Config]  [开关]
  ├─ ▼ 子配置1 [单个随机 / 字符串]
  │    └─ 字符串内容: 3 个项目
  ├─ ▼ 子配置2 [多个指定数量: 4 / 嵌套Config]
  │    ├─ ...
  │    └─ [添加] [粘贴] [排序] [删除]
  └─ [添加] [粘贴] [排序] [删除]
```

### 层级缩进

非根节点会自动缩进 20 像素，形成清晰的层级结构。

### 编辑配置

点击配置名称右侧的描述文本，打开编辑对话框：

1. **点击标题**：修改配置名称（comment）
2. **选取方法**：下拉选择 5 种算法之一
3. **打乱次序**：切换是否打乱结果（仅 all/multiple_prob）
4. **选中概率**：滑动条 0.0~1.0（仅 multiple_prob）
5. **选中数量**：输入框（仅 multiple_num/single_sequential）
6. **随机括号数量**：范围滑动条 -10~+10
7. **下属设置类型**：字符串 / 嵌套Config

### 操作按钮

| 图标 | 功能 |
|------|------|
| ➕ | 插入新的空配置 |
| 📋 | 从剪贴板导入 JSON 配置 |
| 🔄 | 重新排序子配置（拖拽界面） |
| ➖ | 删除选中的配置（多选界面） |

### 拖拽重排序

- 使用 Flutter 原生 `ReorderableListView`
- 长按拖动调整顺序
- 支持子配置项重排序和角色重排序

### 字符串编辑

点击"字符串内容"区域打开多行编辑器：
- 每行一个提示词
- 空行会被自动过滤
- 支持复制粘贴

### 导入/导出

- **导出到剪贴板**：将当前配置序列化为 JSON（可分享给他人）
- **从剪贴板导入**：解析 JSON 并添加到当前配置

---

## 配置示例

### 示例 1：基础角色随机

```json
{
  "selectionMethod": "single",
  "type": "str",
  "comment": "角色",
  "strs": [
    "[[nekomiya hinata]]",
    "[[rosmontis (arknights)]]"
  ]
}
```

效果：每次随机选择一个角色。

### 示例 2：带权重的画师混合

```json
{
  "selectionMethod": "multiple_num",
  "num": 4,
  "randomBracketsUpper": 2,
  "randomBracketsLower": 0,
  "shuffled": true,
  "type": "str",
  "comment": "画师",
  "strs": [
    "artist:a",
    "artist:b",
    "artist:c",
    "artist:d",
    "artist:e"
  ]
}
```

效果：随机选 4 个画师，每个随机添加 0~2 层 `{}` 增强括号。

### 示例 3：低概率特殊风格

```json
{
  "selectionMethod": "multiple_prob",
  "prob": 0.03,
  "shuffled": true,
  "type": "str",
  "comment": "特殊风格",
  "strs": [
    "style:lineart",
    "style:pixel_art",
    "style:3d_rendering"
  ]
}
```

效果：每个风格有 3% 概率被选中，通常不会触发，偶尔出现惊喜。

### 示例 4：顺序遍历测试

```json
{
  "selectionMethod": "single_sequential",
  "num": 3,
  "type": "str",
  "comment": "测试角色",
  "strs": ["角色A", "角色B", "角色C"]
}
```

效果：每个角色连续出现 3 次，然后切换到下一个，循环往复。适合批量测试。

### 示例 5：使用变量引用

主配置：
```json
{
  "selectionMethod": "all",
  "type": "str",
  "comment": "主提示词",
  "strs": [
    "1girl, __发色__, __服装__, best quality"
  ]
}
```

保存的配置 - 发色：
```json
{
  "selectionMethod": "single",
  "type": "str",
  "comment": "发色",
  "strs": ["blonde hair", "silver hair", "pink hair"]
}
```

保存的配置 - 服装：
```json
{
  "selectionMethod": "single",
  "type": "str",
  "comment": "服装",
  "strs": ["school uniform", "maid outfit", "casual clothes"]
}
```

效果：生成 `1girl, silver hair, maid outfit, best quality` 等组合。

### 示例 6：嵌套配置

```json
{
  "selectionMethod": "all",
  "type": "config",
  "comment": "完整提示词",
  "prompts": [
    {
      "selectionMethod": "single",
      "type": "str",
      "comment": "角色",
      "strs": ["character_a", "character_b"]
    },
    {
      "selectionMethod": "multiple_num",
      "num": 2,
      "type": "str",
      "comment": "装饰",
      "strs": ["ribbon", "bow", "flower", "hairpin"]
    },
    {
      "selectionMethod": "all",
      "type": "str",
      "comment": "质量",
      "strs": ["best quality", "absurdres"]
    }
  ]
}
```

效果：组合为 `character_a, ribbon, flower, best quality, absurdres`

### 示例 7：文件名模板

设置文件名前缀为：
```
__角色__-__画师__-NAI
```

如果本次生成的"角色"配置选中了 `nekomiya_hinata`，"画师"选中了 `artist_test`，则文件名为：
```
nekomiya_hinata-artist_test-NAI-20241225143052-abc123.png
```

---

## 相关文件索引

### 核心模型

| 文件路径 | 说明 |
|----------|------|
| `lib/data/models/prompt_config.dart` | PromptConfig 和 NestedPrompt 定义 |
| `lib/data/models/payload_config.dart` | 总配置容器 |
| `lib/data/models/character_config.dart` | 角色配置模型 |
| `lib/data/models/param_config.dart` | 生成参数配置 |
| `lib/data/models/settings.dart` | 应用设置（含 fileNamePrefixKey） |

### 生成逻辑

| 文件路径 | 说明 |
|----------|------|
| `lib/data/use_cases/generate_payload_use_case.dart` | 核心生成逻辑 |

### 服务层

| 文件路径 | 说明 |
|----------|------|
| `lib/data/services/config_service.dart` | 配置持久化服务 |
| `lib/data/services/file_service.dart` | 文件操作服务 |

### UI 层

| 文件路径 | 说明 |
|----------|------|
| `lib/ui/prompt_config/widgets/prompt_config_view.dart` | 树形配置视图 |
| `lib/ui/prompt_config/widgets/prompt_config_edit_view.dart` | 配置编辑对话框 |
| `lib/ui/prompt_config/widgets/prompt_config_reorder_view.dart` | 拖拽排序视图 |
| `lib/ui/prompt_config/widgets/prompt_config_delete_view.dart` | 删除管理视图 |
| `lib/ui/prompt_config/view_models/prompt_config_viewmodel.dart` | 配置 ViewModel |
| `lib/ui/prompt_tab/widgets/prompt_tab_view.dart` | Prompt 标签页主入口 |
| `lib/ui/saved_config_list/widgets/saved_config_list_view.dart` | 保存配置管理页面 |

### 资源文件

| 文件路径 | 说明 |
|----------|------|
| `assets/l10n/zh-CN.json` | 中文本地化文本 |
| `assets/l10n/en.json` | 英文本地化文本 |
| `assets/json/example.json` | 配置示例文件 |

---

## 附录：常见问题

### Q: 变量替换没有生效？

A: 检查以下几点：
1. 保存的配置的 `comment` 名称是否与变量名完全匹配
2. 是否在"保存的配置"页面添加了该配置
3. 变量格式是否正确（双下划线包裹）

### Q: 顺序遍历模式不按顺序？

A: `single_sequential` 模式的索引状态保存在内存中。如果重启应用，索引会重置为 0。

### Q: 如何实现"必选 + 随机"的组合？

A: 使用嵌套配置：
- 外层设为 `all`（全部选中）
- 包含一个 `all` 类型的固定前缀配置
- 包含一个 `single` 或 `multiple_num` 类型的随机配置

### Q: 括号权重具体影响多大？

A: NovelAI 中：
- 每层 `{}` 约增强 1.05 倍
- 每层 `[]` 约降低 0.95 倍
- 3 层 `{{{...}}}` ≈ 1.16 倍增强

### Q: 如何设置 single_sequential 的重复次数？

A: 由于 UI 中没有提供编辑入口，需要通过以下方式：
1. 点击配置旁的"导出到剪贴板"按钮
2. 在文本编辑器中修改 JSON 中的 `"num": X` 值
3. 删除原配置，然后"从剪贴板导入"修改后的 JSON

### Q: 为什么生成的提示词顺序每次都不同？

A: 检查是否启用了 `shuffled`（打乱次序）选项。如需固定顺序，请在编辑对话框中取消勾选"打乱次序"。

---

## 文档审核记录

### 版本信息

- **文档版本**：1.0
- **最后更新**：2024-12-25
- **审核状态**：已完成

### 审核发现与修正

| 问题 | 严重程度 | 状态 |
|------|----------|------|
| `single_sequential` 的 num 参数 UI 联动描述错误 | 中 | ✅ 已修正 |
| 缺少 JSON 编辑方式说明 | 低 | ✅ 已补充 |
| 缺少 shuffled 选项 FAQ | 低 | ✅ 已补充 |

### 已验证内容

- [x] PromptConfig 字段定义与源码一致
- [x] 5 种选择算法逻辑与源码一致
- [x] 随机括号算法与源码一致
- [x] 变量替换正则表达式与源码一致
- [x] 位置坐标映射表与源码一致
- [x] UI 联动规则与源码一致（已修正）
- [x] 生成流程与 GeneratePayloadUseCase 一致
- [x] 文件名生成机制与源码一致
- [x] 存储机制描述与 ConfigService/FileService 一致

### 已知限制

1. **single_sequential 的 UI 限制**：`num` 参数无法在 UI 中直接编辑，需通过 JSON 导入/导出
2. **顺序遍历状态**：`_sequentialIdx` 和 `_sequentialRepeatIdx` 保存在内存中，重启应用后会重置
3. **角色数量上限**：最多支持 5 个角色（NAI API 限制）
