# Vibe 图片自动编码导入设计

## 功能概述

在 Vibe 库导入图片时，如果检测到图片没有嵌入的 Vibe 数据，弹出配置对话框让用户选择是否对该图片进行服务端编码，然后自动保存到 Vibe 库。

## 用户流程

```
用户选择图片导入
    ↓
尝试提取 Vibe 数据
    ↓
未找到 Vibe 数据
    ↓
显示"编码配置弹窗"：
├─ 图片缩略图预览
├─ 名称输入框（默认值：vibe_日期时间）
├─ Strength 滑块 (0.0 - 1.0)
├─ Info Extracted 滑块 (0.0 - 1.0)
└─ [取消] [开始编码]
    ↓
点击"开始编码"
    ↓
显示"编码中"状态（旋转动画 + 文字）
    ↓
编码成功
    ↓
自动保存为 .naiv4vibe 文件到 Vibe 库
    ↓
继续处理下一张（如有）
    ↓
显示最终导入结果

编码失败
    ↓
显示错误提示弹窗：
├─ 错误信息
└─ [跳过] [重试]
```

## 设计决策

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 编码后处理 | 保存为 .naiv4vibe 文件 | 与现有 Vibe 库格式一致，便于管理 |
| 参数设置 | 弹窗中调整 | 给用户充分的控制权 |
| 批量处理 | 逐张询问 | 允许为每张图片设置不同参数 |
| Vibe 命名 | 弹窗中输入 | 默认使用日期时间格式，用户可修改 |
| 弹窗内容 | 完整配置界面 | 缩略图 + 滑块 + 名称输入框 |
| 失败处理 | 阻塞式处理 | 显示错误提示，让用户选择重试或跳过 |
| 进度显示 | 旋转动画 | 简单加载状态，不显示详细进度 |

## 界面规格

### 编码配置弹窗

- **标题**：将此图片编码为 Vibe
- **图片缩略图**：自适应大小，最大 200px
- **名称输入**：默认值 `vibe_YYYYMMDD_HHMMSS`，用户可编辑
- **Strength 滑块**：0.0 - 1.0，步进 0.05，默认 0.6
- **Info Extracted 滑块**：0.0 - 1.0，步进 0.05，默认 0.7
- **底部提示**："编码将消耗 2 Anlas"
- **按钮**：取消 / 开始编码

### 编码中弹窗

- 居中旋转动画
- 文字："正在编码图片..."

### 失败处理弹窗

- **标题**：编码失败
- **内容**：具体错误信息（如"网络超时"、"API 调用失败"）
- **按钮**：跳过此图 / 重试

## 技术实现

### 关键组件

1. **VibeImageEncodeDialog** - 编码配置弹窗
2. **VibeImageEncodingDialog** - 编码中状态弹窗
3. **VibeImageEncodeErrorDialog** - 编码失败弹窗

### API 复用

- 编码调用：`GenerationParamsNotifier.encodeVibeWithCache()`
- 保存调用：`VibeLibraryNotifier.saveEntry()`

### 异常处理

- 捕获 `NoVibeDataException` 触发编码流程
- API 超时：30 秒
- 网络错误：提供重试选项

### 状态管理

- 使用临时状态管理逐张处理流程
- 保持用户选择的参数在批量处理中的一致性

## 文件位置

- 弹窗组件：`lib/presentation/screens/vibe_library/widgets/vibe_image_encode_dialog.dart`
- 修改文件：`lib/presentation/screens/vibe_library/vibe_library_screen.dart`

## 验收标准

- [ ] 导入无 Vibe 数据的 PNG 图片时弹出编码配置弹窗
- [ ] 弹窗中显示图片缩略图、名称输入框、参数滑块
- [ ] 编码时显示加载状态
- [ ] 编码成功后自动保存到 Vibe 库
- [ ] 编码失败时显示错误提示，支持重试或跳过
- [ ] 多张图片时逐张处理
- [ ] 最终导入结果正确统计成功/失败数量
