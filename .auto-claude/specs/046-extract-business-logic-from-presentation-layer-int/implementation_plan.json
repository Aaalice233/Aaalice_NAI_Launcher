{
  "feature": "Extract business logic from presentation layer into services",
  "description": "Business logic is scattered throughout presentation layer files, particularly in prompt_config_screen.dart (1,734 lines), login_screen.dart (1,371 lines), and online_gallery_screen.dart (1,392 lines). These UI files contain complex business logic for error handling, tag counting, date formatting, and state management that should be in services or providers. This violates separation of concerns and makes business logic untestable.",
  "workflow_type": "refactor",
  "workflow_rationale": "This is a refactoring task because we are extracting logic from existing code without changing user-facing behavior. The refactor workflow is appropriate because: (1) we need to add new services alongside existing UI code, (2) we need to migrate consumers (UI screens) to use the new services, (3) we must ensure existing behavior is preserved, and (4) we will remove old logic from UI files only after migration is complete.",
  "created_at": "2026-01-26T07:50:29.179Z",
  "updated_at": "2026-01-26T13:19:00.194Z",
  "status": "in_progress",
  "phases": [
    {
      "id": "phase-1-add-auth-error-service",
      "name": "Add Auth Error Service",
      "type": "implementation",
      "description": "Create AuthErrorService to extract error message formatting logic from login_screen.dart. This service will handle mapping error codes to user-friendly messages and recovery hints.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create AuthErrorService with error message formatting logic",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "lib/core/services/auth_error_service.dart"
          ],
          "patterns_from": [
            "lib/core/services/avatar_service.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/core/services/auth_error_service.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Create unit tests for AuthErrorService",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "test/core/services/auth_error_service_test.dart"
          ],
          "patterns_from": [
            "test/data/models/prompt/tag_favorite_test.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter test test/core/services/auth_error_service_test.dart",
            "expected": "All tests passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-add-tag-counting-service",
      "name": "Add Tag Counting Service",
      "type": "implementation",
      "description": "Create TagCountingService to extract tag counting and filtering logic from prompt_config_screen.dart. This service will handle tag count aggregation, filtering, and selection state calculations.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create TagCountingService with tag counting logic",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "lib/core/services/tag_counting_service.dart"
          ],
          "patterns_from": [
            "lib/core/services/tag_data_service.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/core/services/tag_counting_service.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Create unit tests for TagCountingService",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "test/core/services/tag_counting_service_test.dart"
          ],
          "patterns_from": [
            "test/data/models/prompt/tag_favorite_test.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter test test/core/services/tag_counting_service_test.dart",
            "expected": "All tests passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-add-date-formatting-service",
      "name": "Add Date Formatting Service",
      "type": "implementation",
      "description": "Create DateFormattingService to extract date formatting logic from online_gallery_screen.dart and login_screen.dart. This service will handle date and date range formatting with consistent patterns.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create DateFormattingService with date formatting logic",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "lib/core/services/date_formatting_service.dart"
          ],
          "patterns_from": [
            "lib/core/services/avatar_service.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/core/services/date_formatting_service.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-2",
          "description": "Create unit tests for DateFormattingService",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [
            "test/core/services/date_formatting_service_test.dart"
          ],
          "patterns_from": [
            "test/data/models/prompt/tag_favorite_test.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter test test/core/services/date_formatting_service_test.dart",
            "expected": "All tests passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-4-migrate-login-screen",
      "name": "Migrate Login Screen to Use AuthErrorService",
      "type": "implementation",
      "description": "Update login_screen.dart to use AuthErrorService instead of inline error handling logic. Verify that all error messages and recovery hints work correctly.",
      "depends_on": [
        "phase-1-add-auth-error-service"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Update login_screen.dart to inject and use AuthErrorService",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/screens/auth/login_screen.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-2",
          "description": "Remove _getErrorText and _getErrorRecoveryHint methods from login_screen.dart",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -n '_getErrorText\\|_getErrorRecoveryHint' lib/presentation/screens/auth/login_screen.dart || echo 'Methods removed successfully'",
            "expected": "Methods removed successfully"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-5-migrate-prompt-config-screen",
      "name": "Migrate Prompt Config Screen to Use TagCountingService",
      "type": "implementation",
      "description": "Update prompt_config_screen.dart to use TagCountingService instead of inline tag counting logic. Verify that tag counts and filtering work correctly.",
      "depends_on": [
        "phase-2-add-tag-counting-service"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Update prompt_config_screen.dart to inject and use TagCountingService",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/prompt_config/prompt_config_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/screens/prompt_config/prompt_config_screen.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/screens/prompt_config/prompt_config_screen.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-5-2",
          "description": "Remove inline tag counting logic from prompt_config_screen.dart",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/prompt_config/prompt_config_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter test test/integration/ --name=prompt",
            "expected": "All tests passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-6-migrate-online-gallery-screen",
      "name": "Migrate Online Gallery Screen to Use DateFormattingService",
      "type": "implementation",
      "description": "Update online_gallery_screen.dart and login_screen.dart to use DateFormattingService instead of inline date formatting logic. Verify that date formatting works correctly.",
      "depends_on": [
        "phase-3-add-date-formatting-service"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Update online_gallery_screen.dart to use DateFormattingService",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/online_gallery/online_gallery_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/screens/online_gallery/online_gallery_screen.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/screens/online_gallery/online_gallery_screen.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-6-2",
          "description": "Update login_screen.dart to use DateFormattingService for date formatting",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/screens/auth/login_screen.dart",
            "expected": "No issues found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-6-3",
          "description": "Remove _formatDate and _formatDateRange methods from UI files",
          "service": "app",
          "files_to_modify": [
            "lib/presentation/screens/online_gallery/online_gallery_screen.dart",
            "lib/presentation/screens/auth/login_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -n '_formatDate\\|_formatDateRange' lib/presentation/screens/online_gallery/online_gallery_screen.dart lib/presentation/screens/auth/login_screen.dart || echo 'Methods removed successfully'",
            "expected": "Methods removed successfully"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-7-integration-testing",
      "name": "Integration Testing and Verification",
      "type": "integration",
      "description": "Run all tests to verify that the refactoring maintains existing behavior. Check that all UI screens work correctly and no functionality is broken.",
      "depends_on": [
        "phase-4-migrate-login-screen",
        "phase-5-migrate-prompt-config-screen",
        "phase-6-migrate-online-gallery-screen"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "Run all unit tests to verify service logic",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter test",
            "expected": "All tests passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-7-2",
          "description": "Run integration tests to verify UI behavior unchanged",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter test integration_test/",
            "expected": "All tests passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-7-3",
          "description": "Run flutter analyze to verify no warnings",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze",
            "expected": "No issues found"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-8-cleanup",
      "name": "Cleanup and Documentation",
      "type": "cleanup",
      "description": "Final cleanup tasks including code formatting, adding documentation comments, and verifying line count reduction in UI files.",
      "depends_on": [
        "phase-7-integration-testing"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-8-1",
          "description": "Format all modified files with dart format",
          "service": "app",
          "files_to_modify": [
            "lib/core/services/auth_error_service.dart",
            "lib/core/services/tag_counting_service.dart",
            "lib/core/services/date_formatting_service.dart",
            "lib/presentation/screens/auth/login_screen.dart",
            "lib/presentation/screens/prompt_config/prompt_config_screen.dart",
            "lib/presentation/screens/online_gallery/online_gallery_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "dart format lib/core/services/*.dart lib/presentation/screens/**/*.dart",
            "expected": "Formatted"
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-2",
          "description": "Verify line count reduction in UI files",
          "service": "app",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Check line counts: login_screen.dart should be reduced from 1,371 lines, prompt_config_screen.dart from 1,734 lines, online_gallery_screen.dart from 1,392 lines. Target is 10-20% reduction per file."
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 8,
    "total_subtasks": 18,
    "services_involved": [
      "app"
    ],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-1-add-auth-error-service",
            "phase-2-add-tag-counting-service",
            "phase-3-add-date-formatting-service"
          ],
          "reason": "All three phases create independent services with no overlapping files or dependencies"
        }
      ],
      "recommended_workers": 3,
      "speedup_estimate": "1.8x faster than sequential (3 services can be created in parallel)"
    },
    "startup_command": "flutter run -d windows"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "parallel_with_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New services have unit tests with >80% coverage",
      "UI screens function identically to before refactoring",
      "Business logic is testable without Flutter widget tests",
      "Line count of UI files reduced by 10-20%",
      "No Flutter analyze warnings"
    ],
    "verification_steps": [
      {
        "name": "Service Unit Tests",
        "command": "flutter test test/core/services/",
        "expected_outcome": "All service unit tests pass (auth_error, tag_counting, date_formatting)",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Existing Tests",
        "command": "flutter test",
        "expected_outcome": "All existing tests still pass (no regressions)",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "flutter test integration_test/",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Static Analysis",
        "command": "flutter analyze",
        "expected_outcome": "No issues found",
        "type": "lint",
        "required": true,
        "blocking": true
      },
      {
        "name": "Manual UI Testing",
        "instructions": "Test login error messages, prompt config tag counting, and online gallery date formatting manually",
        "type": "manual",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk change because we are refactoring existing code. We need unit tests for the new services to ensure business logic works correctly, and integration tests to ensure UI behavior is unchanged. Security scanning not required as this is business logic extraction with no security implications."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "flutter test test/core/services/auth_error_service_test.dart",
        "flutter test test/core/services/tag_counting_service_test.dart",
        "flutter test test/core/services/date_formatting_service_test.dart"
      ],
      "minimum_coverage": 80
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "flutter test integration_test/"
      ],
      "services_to_test": [
        "app"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false
    },
    "ui_verification": {
      "required": true,
      "screens": [
        {
          "name": "Login Screen",
          "file": "lib/presentation/screens/auth/login_screen.dart",
          "checks": [
            "Error messages display correctly",
            "Recovery hints shown",
            "Date formatting works"
          ]
        },
        {
          "name": "Prompt Config Screen",
          "file": "lib/presentation/screens/prompt_config/prompt_config_screen.dart",
          "checks": [
            "Tag counts display accurately",
            "Tag filtering works",
            "Selection state correct"
          ]
        },
        {
          "name": "Online Gallery Screen",
          "file": "lib/presentation/screens/online_gallery/online_gallery_screen.dart",
          "checks": [
            "Date range formatting works",
            "Date picker integration works"
          ]
        }
      ]
    },
    "code_quality_checks": {
      "required": true,
      "checks": [
        "No Flutter analyze warnings",
        "All new code formatted with dart format",
        "Documentation comments on all public service APIs",
        "UI files have 10-20% fewer lines than before"
      ]
    }
  },
  "qa_signoff": null,
  "planStatus": "in_progress"
}