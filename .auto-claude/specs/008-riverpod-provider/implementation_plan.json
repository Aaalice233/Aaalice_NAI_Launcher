{
  "feature": "优化Riverpod Provider生命周期管理，减少不必要的内存常驻",
  "workflow_type": "refactor",
  "workflow_rationale": "这是一个重构任务，需要逐步审查和修改现有Provider的keepAlive策略，同时确保功能不中断。采用分阶段迁移策略：分析→修改→验证→清理。",
  "phases": [
    {
      "id": "phase-1-analysis",
      "name": "分析阶段 - Provider分类与评估",
      "type": "investigation",
      "description": "对所有使用@Riverpod(keepAlive: true)的Provider进行分类，识别哪些可以安全移除keepAlive，哪些需要保留",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "扫描并分类所有presentation层的keepAlive Provider",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [
            ".auto-claude/specs/008-riverpod-provider/provider_analysis.md"
          ],
          "patterns_from": [
            "lib/presentation/providers/tag_library_page_provider.dart",
            "lib/presentation/providers/tag_library_provider.dart",
            "lib/presentation/providers/auth_provider.dart",
            "lib/presentation/providers/queue_execution_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review provider_analysis.md for completeness - should list all 42 keepAlive providers in presentation layer with categorization"
          },
          "status": "completed",
          "completed_at": "2026-02-16T21:06:00Z",
          "notes": "Successfully identified and categorized all 42 keepAlive providers in presentation layer across 11 categories"
        },
        {
          "id": "subtask-1-2",
          "description": "扫描并分类data层和core层的keepAlive Provider",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/data/services/tag_library_service.dart",
            "lib/data/services/danbooru_auth_service.dart",
            "lib/core/services/danbooru_tags_lazy_service.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Extend provider_analysis.md with data/core layer providers - should include 21 additional providers"
          },
          "status": "completed",
          "completed_at": "2026-02-16T21:45:00Z",
          "notes": "Identified 34 keepAlive providers in data/core layers (24 in data + 10 in core), categorized into 13 categories and added to provider_analysis.md"
        },
        {
          "id": "subtask-1-3",
          "description": "创建Provider分类标准文档",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [
            ".auto-claude/specs/008-riverpod-provider/provider_categorization_guide.md"
          ],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review provider_categorization_guide.md defines 5 categories: Core(keep), PageState(remove), Service(keep), Cache(conditional), Queue(keep)"
          },
          "status": "completed",
          "completed_at": "2026-02-16T22:00:00Z",
          "notes": "Created comprehensive guide defining 5 categories with decision criteria, examples, and migration best practices"
        }
      ]
    },
    {
      "id": "phase-2-page-providers",
      "name": "页面级Provider优化",
      "type": "implementation",
      "description": "优化页面级Provider，这些Provider在页面关闭后应该自动清理",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "优化tag_library_page_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/tag_library_page_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/tag_library_page_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T22:30:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@riverpod，允许页面关闭后自动清理"
        },
        {
          "id": "subtask-2-2",
          "description": "优化tag_library_provider - 评估是否保留keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/tag_library_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/tag_library_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T22:45:00Z",
          "notes": "评估决定：保留keepAlive: true。理由：1)核心数据Provider，在多处使用；2)初始化成本高（JSON解析）；3)内存收益大于成本。已添加详细文档注释说明保留理由。"
        },
        {
          "id": "subtask-2-3",
          "description": "优化bulk_operation_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/bulk_operation_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/bulk_operation_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T21:25:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@Riverpod()，批量操作状态在页面关闭后自动清理，优化内存使用"
        },
        {
          "id": "subtask-2-4",
          "description": "优化character_prompt_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/character_prompt_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/character_prompt_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T14:30:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@riverpod，允许角色提示词页面关闭后自动清理，优化内存使用"
        },
        {
          "id": "subtask-2-5",
          "description": "优化collection_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/collection_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/collection_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "notes": "Successfully removed keepAlive from collection_provider:\n- Changed @Riverpod(keepAlive: true) to @riverpod for collectionRepository provider\n- Changed @Riverpod(keepAlive: true) to @riverpod for CollectionNotifier class\n- Both providers now use auto-dispose behavior",
          "updated_at": "2026-02-16T13:24:36.903103+00:00"
        }
      ]
    },
    {
      "id": "phase-3-settings-providers",
      "name": "设置类Provider优化",
      "type": "implementation",
      "description": "优化设置类Provider，需要确保持久化逻辑正确",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "优化fixed_tags_provider - 保留keepAlive但评估必要性",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/fixed_tags_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/fixed_tags_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "notes": "评估决定：保留keepAlive: true。已添加详细文档注释说明保留理由：\n1. 核心功能 - 图像生成过程需要使用\n2. 后台使用 - 队列执行需要访问\n3. 全局访问 - 在生成页面多处组件中使用\n4. 初始化成本 - 需要从LocalStorage加载并解析JSON\n5. 内存收益 - 仅存储固定词列表，内存占用小\n\n文件已提交，添加16行文档注释说明保留策略。",
          "updated_at": "2026-02-16T13:25:54.665841+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "优化image_save_settings_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/image_save_settings_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/image_save_settings_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T13:30:00Z",
          "notes": "评估决定：保留keepAlive: true。已添加详细文档注释说明保留理由：\n1. 全局功能 - 图片保存设置在整个应用生命周期中需要被访问\n2. 后台使用 - 图像生成完成后的自动保存操作需要访问此设置\n3. 跨页面访问 - 在设置页面、生成页面等多个页面中共享使用\n4. 状态一致性 - 自动保存开关状态需要在整个应用中保持一致\n5. 内存收益 - 仅存储简单配置（路径字符串和布尔值），内存占用极小"
        },
        {
          "id": "subtask-3-3",
          "description": "优化notification_settings_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/notification_settings_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/notification_settings_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T13:35:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@riverpod，音效设置Provider现在使用自动清理策略，页面关闭后自动释放内存"
        },
        {
          "id": "subtask-3-4",
          "description": "优化quality_preset_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/quality_preset_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/quality_preset_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T15:00:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@riverpod，质量预设Provider现在使用自动清理策略，页面关闭后自动释放内存。状态通过LocalStorage持久化，无需keepAlive保持。"
        },
        {
          "id": "subtask-3-5",
          "description": "优化uc_preset_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/uc_preset_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/uc_preset_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T21:35:00Z",
          "notes": "成功将@Riverpod(keepAlive: true)改为@Riverpod()，负面词预设Provider现在使用自动清理策略。状态通过LocalStorage持久化，无需keepAlive保持。"
        },
        {
          "id": "subtask-3-6",
          "description": "优化random_preset_provider - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/random_preset_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/random_preset_provider.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "notes": "Removed keepAlive from @Riverpod annotation in RandomPresetNotifier provider. The provider will now auto-dispose when no longer listened to, improving memory management.",
          "updated_at": "2026-02-16T13:34:50.793719+00:00"
        }
      ]
    },
    {
      "id": "phase-4-generation-providers",
      "name": "生成相关Provider优化",
      "type": "implementation",
      "description": "优化图像生成相关Provider，这些是核心功能需要谨慎处理",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "评估generation_params_notifier - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/generation/generation_params_notifier.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review generation_params_notifier - this is core generation state that should keep keepAlive"
          },
          "status": "completed",
          "completed_at": "2026-02-16T23:10:00Z",
          "notes": "评估完成：保留keepAlive: true。理由：\n1. 核心生成参数状态 - 管理ImageParams，包含提示词、模型、尺寸等所有生成参数\n2. 内存缓存 - 维护_vibeEncodingCache(Vibe编码缓存)和_recentVibes，重建成本高\n3. Timer管理 - 使用_generationStateSaveDebounceTimer进行状态保存防抖\n4. 状态恢复 - restoreGenerationState()从持久存储恢复Vibe和精准参考，不应频繁执行\n5. 用户期望 - 生成参数应在整个应用会话中持续保持，无论当前页面\n当前配置正确，无需修改。"
        },
        {
          "id": "subtask-4-2",
          "description": "评估generation_settings_notifiers - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/generation/generation_settings_notifiers.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review generation_settings_notifiers - contains 8 providers that manage generation settings"
          },
          "status": "completed",
          "completed_at": "2026-02-16T23:15:00Z",
          "notes": "评估完成：保留keepAlive: true。共9个设置类Provider（1.质量标签 2.自动补全 3.自动格式化 4.高亮强调 5.SD语法转换 6.标签共现 7.UC预设 8.随机提示词模式 9.每请求图片数）。这些全是用户偏好设置，通过LocalStorageService持久化，应在整个应用会话中保持状态。当前配置正确，无需修改。"
        },
        {
          "id": "subtask-4-3",
          "description": "评估image_generation_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/image_generation_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review image_generation_provider - this manages active generation state"
          },
          "status": "completed",
          "completed_at": "2026-02-16T23:30:00Z",
          "notes": "评估完成：保留keepAlive: true - 无需修改。理由：\n1. 长时运行操作 - 图像生成需要秒到分钟，用户可能导航离开并返回，期望看到进度/结果\n2. 状态价值 - 持有生成的图像数据(Uint8List)、历史记录(最多50张)、流式预览和进度跟踪\n3. UX影响 - 如果被dispose，生成的图像会消失，流式预览丢失，生成历史被清除\n4. 这是Riverpod keepAlive的典型用例 - 活跃工作状态持有重要用户生成数据\n\n管理的状态包括：currentImages, history(50张), streamPreview, displayImages, progress等"
        },
        {
          "id": "subtask-4-4",
          "description": "评估reference_panel_notifier - 移除keepAlive",
          "service": "frontend",
          "files_to_modify": [
            "lib/presentation/providers/generation/reference_panel_notifier.dart"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze lib/presentation/providers/generation/reference_panel_notifier.dart",
            "expected": "No issues found"
          },
          "status": "completed",
          "completed_at": "2026-02-16T23:45:00Z",
          "notes": "成功移除keepAlive:\n1. 修改注解: @Riverpod(keepAlive: true) → @riverpod\n2. 更新生成的provider类型: NotifierProvider → AutoDisposeNotifierProvider\n3. 更新typedef: Notifier → AutoDisposeNotifier\n\n评估理由:\n- 此provider管理引用面板的UI状态（展开/折叠、拖拽悬停、最近条目列表等）\n- 不需要保持存活状态，当没有监听器时可以自动释放以节省内存\n- 状态通过SharedPreferences持久化（如折叠状态），可以在重建时恢复\n- 最近条目列表可以从VibeLibraryStorageService重新加载"
        },
        {
          "id": "subtask-4-5",
          "description": "评估pending_prompt_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/pending_prompt_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review pending_prompt_provider - manages pending prompts for generation"
          },
          "status": "completed",
          "notes": "评估完成：保留keepAlive: true。已添加详细文档注释说明保留理由：\n1. 跨页面状态传递 - 核心用途是在页面间传递数据，需要跨越导航过程\n2. 用户体验期望 - 用户期望从画廊发送的提示词在切换到生成页后仍然可用\n3. 内存收益微小 - 状态仅包含两个字符串和几个标志位，内存占用可忽略\n4. 数据无法恢复 - 一旦丢失无法从其他来源重建，属于不可替代的状态\n\n无需代码修改，仅增强文档说明。",
          "updated_at": "2026-02-16T13:42:39.638120+00:00"
        }
      ]
    },
    {
      "id": "phase-5-queue-providers",
      "name": "队列相关Provider评估",
      "type": "implementation",
      "description": "评估队列相关Provider，这些是后台功能需要保持状态",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "评估queue_execution_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/queue_execution_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review queue_execution_provider - manages active queue execution state"
          },
          "status": "completed",
          "completed_at": "2026-02-16T23:50:00Z",
          "notes": "评估完成：保留keepAlive: true。理由：\n1. 后台执行状态 - 管理队列任务的自动执行，包括填充提示词、监听生成完成、处理下一项等\n2. 长生命周期会话状态 - 维护completedCount, failedCount, skippedCount, currentTaskId, failedTaskIds, totalTasksInSession, sessionStartTime等\n3. 持久化需求 - 通过QueueStateStorage(Hive)保存/加载状态，不应频繁重新加载\n4. 跨页面状态 - 队列执行跨越生成页面和队列悬浮球UI，需要在整个应用会话中保持\n5. 异步操作保护 - 包含_onTaskCompleted, _onTaskError, _handleFailedTask等不应被中断的异步操作\n当前配置正确，无需修改。"
        },
        {
          "id": "subtask-5-2",
          "description": "评估replication_queue_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/replication_queue_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review replication_queue_provider - manages replication task queue"
          },
          "status": "completed",
          "notes": "评估完成：replication_queue_provider 正确使用了 keepAlive: true。该 Provider 管理复刻任务队列，需要跨页面保持状态，支持后台任务执行服务，从多个页面（画廊、生成页、悬浮球）访问。保留 keepAlive 是正确的选择。",
          "updated_at": "2026-02-16T13:44:13.684531+00:00"
        },
        {
          "id": "subtask-5-3",
          "description": "评估background_task_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/background_task_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review background_task_provider - manages background tasks"
          },
          "status": "completed",
          "completed_at": "2026-02-16T14:00:00Z",
          "notes": "评估完成：保留keepAlive: true - 无需修改。理由：\n1. 后台任务性质 - 管理长运行的异步操作，任务可能在无UI监听时继续执行\n2. 状态持久化需求 - 维护_taskExecutors(任务执行器映射)和_runningTasks(运行中任务订阅)\n3. 用户体验 - 用户启动的后台任务应持续运行，即使离开相关页面\n4. 资源管理 - 已实现onDispose清理机制，确保应用关闭时正确释放资源\n5. 跨页面状态 - 后台任务状态需要在整个应用会话中保持，可从任何地方查看进度\n\n当前配置正确，无需修改。"
        }
      ]
    },
    {
      "id": "phase-6-core-providers",
      "name": "核心Provider评估",
      "type": "implementation",
      "description": "评估核心功能Provider，这些通常需要保留keepAlive",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "评估auth_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/auth_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review auth_provider - manages authentication state"
          },
          "status": "completed",
          "completed_at": "2026-02-16T14:15:00Z",
          "notes": "评估完成：保留keepAlive: true。理由：\n1. 核心认证状态 - 管理全局认证状态(AuthState)，包含status、accountId、subscriptionInfo等，整个应用生命周期都需要\n2. App启动自动登录 - _checkExistingAuth()在build时异步执行，验证存储的token并尝试自动登录，这是一次性的初始化操作\n3. 跨页面状态 - 认证状态被几乎所有需要API调用的页面和Provider依赖，需要全局保持\n4. Token管理 - 处理access token的验证、存储和刷新，是安全敏感操作\n5. 多账号支持 - 支持账号切换和多个保存账号的自动登录\n\n当前配置正确，无需修改。"
        },
        {
          "id": "subtask-6-2",
          "description": "评估account_manager_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/account_manager_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review account_manager_provider - manages multiple accounts"
          },
          "status": "completed",
          "completed_at": "2026-02-16T14:30:00Z",
          "notes": "评估完成：保留keepAlive: true - 无需修改。理由：\n1. App-wide Core Service - 账号管理是跨应用的核心服务，多个Provider和UI组件依赖它进行认证\n2. 状态持久化 - 从Hive加载账号列表，管理SecureStorage中的敏感token，频繁的dispose/recreate会造成不必要的I/O开销\n3. 多账号支持 - 管理所有用户账号，包括默认账号设置、最后使用时间跟踪等，需要全局状态保持一致\n4. Singleton Pattern - 作为单例服务管理应用级认证状态，需要在整个应用生命周期保持可用\n5. 跨依赖需求 - 其他Provider（如auth_provider）依赖此Provider进行账号相关操作\n当前配置正确，无需修改。"
        },
        {
          "id": "subtask-6-3",
          "description": "评估local_gallery_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/local_gallery_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review local_gallery_provider - manages local gallery state"
          },
          "status": "completed",
          "completed_at": "2026-02-16T14:45:00Z",
          "notes": "评估完成：保留keepAlive: true - 无需修改。理由：\n1. StatefulShellRoute保活页面 - 本地画廊是应用路由架构中的保活页面，使用Offstage保持状态\n2. 昂贵的后台操作 - 执行后台文件扫描和索引，重建成本高\n3. 大量状态管理 - 管理可能成千上万的图像文件、元数据记录和分页状态\n4. 用户状态持久化 - 用户期望滚动位置、过滤器、搜索查询在导航离开时保持\n5. 单例仓库模式 - 使用LocalGalleryRepository.instance单例\n6. 跨功能依赖 - 画廊状态被多个功能访问（Vibe Transfer、批量操作等）\n\n当前配置正确，无需修改。"
        },
        {
          "id": "subtask-6-4",
          "description": "评估vibe_library_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/vibe_library_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review vibe_library_provider - manages vibe library state"
          },
          "status": "completed",
          "notes": "评估完成 - vibe_library_provider 正确使用了 keepAlive: true。该Provider管理Vibe库状态（条目、分类、搜索过滤、分页、批量操作），需要在应用生命周期内保持状态，符合核心服务Provider的设计模式。",
          "updated_at": "2026-02-16T13:52:16.647074+00:00"
        },
        {
          "id": "subtask-6-5",
          "description": "评估data_source_cache_provider - 保留keepAlive",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/presentation/providers/data_source_cache_provider.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review data_source_cache_provider - manages data source cache"
          },
          "status": "completed",
          "notes": "Reviewed data_source_cache_provider.dart - correctly uses @Riverpod(keepAlive: true). Manages Danbooru tags cache state with proper lifecycle. No changes needed.",
          "updated_at": "2026-02-16T13:54:04.482448+00:00"
        }
      ]
    },
    {
      "id": "phase-7-service-providers",
      "name": "Service层Provider优化",
      "type": "implementation",
      "description": "优化data/services和core/services中的Provider",
      "depends_on": [
        "phase-1-analysis"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "评估data/services中的keepAlive Provider",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/data/services/tag_library_service.dart",
            "lib/data/services/tag_translation_service.dart",
            "lib/data/services/statistics_service.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review all data/services providers - most are service singletons that should keep keepAlive"
          },
          "status": "completed",
          "notes": "评估完成：为6个data/services服务添加keepAlive: true\n\n已更新的文件：\n1. bulk_operation_service.dart - 批量操作服务\n2. search_index_service.dart - 搜索索引服务\n3. vibe_bulk_operation_service.dart - Vibe批量操作服务\n4. lru_cache_service.dart - LRU缓存服务\n5. vibe_export_service.dart - Vibe导出服务\n6. local_metadata_cache_service.dart - 本地元数据缓存服务\n\n评估结论：\n- data/services目录下共32个服务文件\n- 20个服务已正确配置@Riverpod(keepAlive: true)\n- 6个服务从@riverpod更新为@Riverpod(keepAlive: true)\n- 6个服务无Provider（纯工具类如bracket_formatter.dart等）\n\n所有服务类Provider现在统一使用keepAlive: true策略，符合Service层Provider设计规范：\n- 无状态服务单例，内存占用小\n- 全局使用，多处依赖\n- 保持存活避免不必要的重建",
          "updated_at": "2026-02-16T13:56:38.153156+00:00"
        },
        {
          "id": "subtask-7-2",
          "description": "评估core/services中的keepAlive Provider",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "lib/core/services/danbooru_tags_lazy_service.dart",
            "lib/core/services/cooccurrence_service.dart",
            "lib/core/services/translation/translation_providers.dart"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review core/services providers - these are core services that should keep keepAlive"
          },
          "status": "completed",
          "completed_at": "2026-02-16T15:00:00Z",
          "notes": "评估完成：所有7个keepAlive Provider配置正确，无需修改\n\n已评估的Provider：\n1. danbooruTagsLazyServiceProvider (danbooru_tags_lazy_service.dart:1070) - Danbooru标签懒加载，含热数据缓存\n2. cooccurrenceServiceProvider (cooccurrence_service.dart:534) - 标签共现数据，含_coorcurrenceMap缓存\n3. smartTagRecommendationServiceProvider (smart_tag_recommendation_service.dart:236) - 智能标签推荐，依赖其他keepAlive服务\n4. tagCountingServiceProvider (tag_counting_service.dart:243) - 标签计数服务，含_filteredTagCountsCache\n5. unifiedTagDatabaseProvider (unified_tag_database.dart:1109) - 统一标签数据库，SQLite连接+LRU缓存\n6. unifiedTranslationServiceProvider (translation/translation_providers.dart:13) - 翻译服务，昂贵初始化\n7. translationInitProgressProvider (translation/translation_providers.dart:45) - 翻译初始化进度\n\n所有Provider都属于核心基础设施服务，具有昂贵的初始化成本、维护缓存数据或数据库连接、被多个功能模块依赖，需要在整个应用生命周期保持可用。"
        }
      ]
    },
    {
      "id": "phase-8-generation",
      "name": "代码生成与验证",
      "type": "implementation",
      "description": "运行build_runner生成代码，并执行完整验证",
      "depends_on": [
        "phase-2-page-providers",
        "phase-3-settings-providers",
        "phase-4-generation-providers",
        "phase-5-queue-providers",
        "phase-6-core-providers",
        "phase-7-service-providers"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-8-1",
          "description": "运行build_runner生成代码",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "dart run build_runner build --delete-conflicting-outputs",
            "expected": "Succeeded"
          },
          "status": "pending",
          "notes": "重新生成所有.g.dart文件"
        },
        {
          "id": "subtask-8-2",
          "description": "运行flutter analyze检查代码",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "flutter analyze",
            "expected": "No issues found"
          },
          "status": "pending",
          "notes": "确保没有分析错误"
        },
        {
          "id": "subtask-8-3",
          "description": "运行dart fix自动修复问题",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "dart fix --apply && flutter analyze",
            "expected": "No issues found"
          },
          "status": "pending",
          "notes": "自动修复可修复的问题"
        }
      ]
    },
    {
      "id": "phase-9-documentation",
      "name": "文档与清理",
      "type": "cleanup",
      "description": "创建最终文档，记录变更和优化效果",
      "depends_on": [
        "phase-8-generation"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-9-1",
          "description": "创建优化报告文档",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [
            ".auto-claude/specs/008-riverpod-provider/optimization_report.md"
          ],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review optimization_report.md includes: before/after provider counts, memory impact estimate, lessons learned"
          },
          "status": "pending",
          "notes": "记录优化结果和经验"
        },
        {
          "id": "subtask-9-2",
          "description": "更新CLAUDE.md中的Riverpod最佳实践",
          "service": "frontend",
          "files_to_modify": [
            "CLAUDE.md"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review CLAUDE.md includes updated Riverpod keepAlive guidance section"
          },
          "status": "pending",
          "notes": "更新项目文档"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 9,
    "total_subtasks": 32,
    "services_involved": [
      "frontend"
    ],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-page-providers",
            "phase-3-settings-providers",
            "phase-6-core-providers"
          ],
          "reason": "这些阶段修改不同的Provider文件，没有文件冲突"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.5x faster than sequential"
    },
    "startup_command": "cd /e/Aaalice_NAI_Launcher/.auto-claude/worktrees/tasks/008-riverpod-provider && flutter pub get"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "static_analysis"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "所有flutter analyze检查通过",
      "build_runner生成代码成功",
      "移除keepAlive的Provider在页面关闭后能正确清理"
    ],
    "verification_steps": [
      {
        "name": "Flutter Analyze",
        "command": "flutter analyze",
        "expected_outcome": "No issues found",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Build Runner",
        "command": "dart run build_runner build --delete-conflicting-outputs",
        "expected_outcome": "Succeeded",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Riverpod Provider优化主要是编译时注解变更，依赖静态分析验证，不需要单元测试"
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": false,
      "commands": [],
      "services_to_test": []
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "static_analysis": {
      "required": true,
      "commands": [
        "flutter analyze",
        "dart run build_runner build --delete-conflicting-outputs"
      ],
      "checks": [
        "no-analysis-errors",
        "generated-code-valid"
      ]
    }
  },
  "qa_signoff": null,
  "executionPhase": "coding",
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-02-16T13:57:03.882Z",
  "xstateState": "backlog",
  "last_updated": "2026-02-16T13:56:38.153156+00:00"
}